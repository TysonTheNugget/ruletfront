<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸŽ° Wishy Washy Rune Lottery - Mainnet</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
    h1 { text-align: center; color: #333; }
    .section { margin: 20px 0; padding: 15px; border: 2px solid #333; border-radius: 10px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .address { font-family: monospace; word-break: break-all; background: #eee; padding: 5px; border-radius: 3px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #e0e0e0; }
    .buttons { display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0; }
    button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; }
    button:hover { background: #0056b3; }
    #logs { white-space: pre-wrap; font-family: monospace; background: #f8f8f8; padding: 10px; height: 200px; overflow-y: auto; border: 1px solid #ddd; font-size: 12px; }
    .error { color: red; font-weight: bold; }
    .no-data { text-align: center; color: #666; font-style: italic; }
  </style>
</head>
<body>
  <h1>ðŸŽ° Wishy Washy Rune Lottery (Mainnet)</h1>

  <div class="section">
    <h2>1. Send Runes</h2>
    <p>Send <strong>WISHYWASHYMACHINE</strong> Runes to (mainnet only):</p>
    <p id="address" class="address">Loading...</p>
    <p id="pot">Current Pot: 0 WISHY</p>
    <p id="last-winner">Last Winner: None</p>
    <p id="next-lottery">Estimated Next Lottery Check: Calculating...</p>
    <p id="balance-error" class="error" style="display: none;"></p>
  </div>

  <div class="section" id="contestants-section" style="display: none;">
    <h2>2. Confirmed Contestants (Current Game)</h2>
    <table id="contestants">
      <thead><tr><th>Alias</th><th>Address</th><th>Amount (WISHY)</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>3. Pending Entries</h2>
    <table id="pending">
      <thead><tr><th>Alias</th><th>Address</th><th>Amount (WISHY)</th><th>Status</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>4. Past Games</h2>
    <table id="history">
      <thead><tr><th>Winner</th><th>Amount (WISHY)</th><th>Date</th><th>TxID</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="buttons">
    <button onclick="initApp()">Init</button>
    <button onclick="poll()">Poll Deposits</button>
    <button onclick="checkLottery()">Check Lottery</button>
    <button onclick="refresh()">Refresh</button>
    <button onclick="resetState()">Reset (Admin)</button>
  </div>

  <div class="section">
    <h2>Logs</h2>
    <div id="logs">Initializing...</div>
  </div>

  <script>
    const apiUrl = 'https://wishyroulette.onrender.com'; // Render backend
    let lastLogTime = 0;

    async function fetchWithLogs(endpoint) {
      const url = `${apiUrl}${endpoint}`;
      const now = Date.now();
      if (now - lastLogTime > 5000) { // Log less frequently
        log(`Fetching ${endpoint}...`);
        lastLogTime = now;
      }
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (!res.ok || !data.success) log(`Error ${endpoint}: ${data.error || res.statusText}`);
        return data;
      } catch (e) {
        log(`Fetch error ${endpoint}: ${e.message}`);
        return { success: false, error: e.message };
      }
    }

    function log(msg) {
      document.getElementById('logs').innerHTML += `${new Date().toLocaleTimeString()}: ${msg}\n`;
      document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
    }

    async function initApp() {
      log('Initializing mainnet...');
      const data = await fetchWithLogs('/init');
      if (data.success) log(`Rune ID: ${data.runeId}, Decimals: ${data.decimals}`);
      await refresh();
    }

    async function poll() {
      log('Polling...');
      const data = await fetchWithLogs('/poll');
      if (data.success) log(`${data.newContributions} new contribs, ${data.newWithdrawals} withdrawals`);
      await refresh();
    }

    async function checkLottery() {
      const apiKey = prompt('Admin API Key:');
      if (!apiKey) return log('Key required');
      const data = await fetchWithLogs(`/check?api_key=${encodeURIComponent(apiKey)}`);
      if (data.success && data.winner) log(`Winner: ${data.winner.slice(0, 8)}...`);
      else if (data.success) log(data.message || 'No action');
      else log(`Check failed: ${data.error}`);
      await refresh();
    }

    async function refresh() {
      const status = await fetchWithLogs('/status');
      if (status.success !== false) {
        document.getElementById('address').textContent = status.address;
        document.getElementById('pot').textContent = `Current Pot: ${status.pot} WISHY`;
        document.getElementById('last-winner').textContent = `Last Winner: ${status.lastWinner ? status.lastWinner.slice(0, 8) + '...' : 'None'}`;
        document.getElementById('balance-error').style.display = status.balanceError ? 'block' : 'none';
        document.getElementById('balance-error').textContent = status.balanceError || '';
        updateTable('contestants', status.contributors || {}, ['alias' in status.contributors ? 'alias' : 'address', 'amount']);
        updateTable('pending', status.pendingContributors || {}, ['alias', 'sender', 'amount', 'status']);
        document.getElementById('contestants-section').style.display = status.hasOpenGame ? 'block' : 'none';
      }

      const historyData = await fetchWithLogs('/history');
      if (historyData.success) updateTable('history', historyData.games || [], ['winner', 'amount', 'timestamp', 'txid'], true);

      const blockTime = await fetchWithLogs('/last-block-time');
      if (blockTime.success) {
        const nextEst = new Date((blockTime.timestamp + 600) * 1000).toLocaleString(); // ~10 min avg block
        document.getElementById('next-lottery').textContent = `Estimated Next Check: ${nextEst}`;
      }
    }

    function updateTable(id, dataObj, fields, formatTime = false) {
      const tbody = document.getElementById(id).querySelector('tbody');
      tbody.innerHTML = '';
      const entries = Object.values(dataObj);
      if (entries.length === 0) {
        const row = tbody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = fields.length;
        cell.className = 'no-data';
        cell.textContent = 'No data (or API issue - check logs)';
        return;
      }
      entries.forEach(item => {
        const row = tbody.insertRow();
        fields.forEach(field => {
          const cell = row.insertCell();
          let val = item[field] || '';
          if (field === 'timestamp' && formatTime) val = val ? new Date(val).toLocaleString() : 'N/A';
          else if (field === 'txid' && val) {
            const a = document.createElement('a');
            a.href = `https://mempool.space/tx/${val}`;
            a.textContent = val.slice(0, 8) + '...';
            a.target = '_blank';
            cell.appendChild(a);
            return;
          } else if (['address', 'sender', 'winner'].includes(field)) val = val ? val.slice(0, 8) + '...' : '';
          cell.textContent = val;
          if (['address', 'sender', 'winner'].includes(field)) cell.title = item[field] || '';
        });
      });
    }

    async function resetState() {
      const apiKey = prompt('Admin API Key:');
      if (!apiKey) return log('Key required');
      const data = await fetchWithLogs(`/reset?api_key=${encodeURIComponent(apiKey)}`);
      log(data.success ? 'Reset OK' : `Reset failed: ${data.error}`);
      await refresh();
    }

    // Auto-refresh every 30s
    setInterval(refresh, 30000);
    window.onload = initApp;
  </script>
</body>
</html>