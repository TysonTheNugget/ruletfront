<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸŽ° Wishy Washy Rune Lottery</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
    h1 { text-align: center; color: #333; }
    .section { margin: 20px 0; padding: 15px; border: 2px solid #333; border-radius: 10px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .address { font-family: monospace; word-break: break-all; background: #eee; padding: 5px; border-radius: 3px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #e0e0e0; }
    .buttons { display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0; }
    button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; }
    button:hover { background: #0056b3; }
    #logs { white-space: pre-wrap; font-family: monospace; background: #f8f8f8; padding: 10px; height: 200px; overflow-y: auto; border: 1px solid #ddd; font-size: 12px; }
    .error { color: red; font-weight: bold; }
    .no-data { text-align: center; color: #666; font-style: italic; }
  </style>
</head>
<body>
  <h1>ðŸŽ° Wishy Washy Rune Lottery</h1>

  <div class="section">
    <h2>1. Send Runes</h2>
    <p>Send WISHYâ€¢WASHYâ€¢MACHINE Runes to:</p>
    <p id="address" class="address">Loading...</p>
    <p id="pot">Current Pot: 0 WISHY</p>
    <p id="last-winner">Last Winner: None</p>
    <p id="next-lottery">Estimated Next Lottery Check: Calculating...</p>
    <p id="balance-error" class="error" style="display: none;"></p>
  </div>

  <div class="section" id="contestants-section" style="display: none;">
    <h2>2. Confirmed Contestants (Current Game)</h2>
    <table id="contestants">
      <thead><tr><th>Alias</th><th>Address</th><th>Amount (WISHY)</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>3. Pending Entries (Next Game)</h2>
    <table id="pending">
      <thead><tr><th>Alias</th><th>Address</th><th>Amount (WISHY)</th><th>Status</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>4. Past Games</h2>
    <table id="history">
      <thead><tr><th>Winner</th><th>Amount (WISHY)</th><th>Date</th><th>TxID</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="buttons">
    <button onclick="initApp()">Init Rune Info</button>
    <button onclick="poll()">Poll for Deposits</button>
    <button onclick="checkLottery()">Check Block / Lottery</button>
    <button onclick="refresh()">Refresh Status</button>
    <button onclick="resetState()">Reset State (Admin)</button>
  </div>

  <div class="section">
    <h2>Logs</h2>
    <div id="logs">Logs will appear here...</div>
  </div>

  <script>
    const apiUrl = 'https://wishyroulette.onrender.com';
    let lastLogTime = 0;

    async function fetchWithLogs(endpoint) {
      const url = `${apiUrl}${endpoint}`;
      const now = Date.now();
      if (now - lastLogTime > 1000) {
        log(`Fetching ${endpoint}`);
        lastLogTime = now;
      }
      try {
        const response = await fetch(url);
        const data = await response.json();
        if (!response.ok || !data.success) {
          log(`Error fetching ${endpoint}: ${data.error || response.statusText}`);
        }
        return data;
      } catch (e) {
        log(`Fetch error for ${endpoint}: ${e.message}`);
        return { success: false, error: e.message };
      }
    }

    function log(message) {
      const logs = document.getElementById('logs');
      logs.innerHTML += `${new Date().toLocaleTimeString()}: ${message}\n`;
      logs.scrollTop = logs.scrollHeight;
    }

    async function initApp() {
      log('Initializing...');
      const data = await fetchWithLogs('/init');
      if (data.success) {
        log(`Rune ID: ${data.runeId}, Decimals: ${data.decimals}`);
      }
      await refresh();
    }

    async function poll() {
      log('Polling for deposits...');
      const data = await fetchWithLogs('/poll');
      if (data.success) {
        log(`New contributions: ${data.newContributions}, New withdrawals: ${data.newWithdrawals}`);
      }
      await refresh();
    }

    async function checkLottery() {
      log('Checking block / lottery...');
      const apiKey = prompt('Enter admin API key:');
      if (!apiKey) {
        log('Admin API key required');
        return;
      }
      const data = await fetchWithLogs('/check?api_key=' + encodeURIComponent(apiKey));
      if (data.success && data.winner) {
        log(`Winner: ${data.winner}`);
      } else if (data.success) {
        log(data.message || 'No action taken');
      }
      await refresh();
    }

    async function refresh() {
      log('Refreshing status...');
      const status = await fetchWithLogs('/status');
      if (status.success) {
        document.getElementById('address').textContent = status.address;
        document.getElementById('pot').textContent = `Current Pot: ${status.pot} WISHY`;
        document.getElementById('last-winner').textContent = `Last Winner: ${status.lastWinner || 'None'}`;
        document.getElementById('balance-error').style.display = status.balanceError ? 'block' : 'none';
        document.getElementById('balance-error').textContent = status.balanceError || '';
        updateTable('contestants', status.contributors, ['address', 'amount']);
        updateTable('pending', status.pendingContributors, ['alias', 'sender', 'amount', 'status']);
        updateContestantsSection(status.hasOpenGame);
      }
      const history = await fetchWithLogs('/history');
      if (history.success) {
        updateTable('history', history.games, ['winner', 'amount', 'timestamp', 'txid'], true);
      }
      const blockTime = await fetchWithLogs('/last-block-time');
      if (blockTime.success) {
        const nextTime = new Date((blockTime.timestamp + 600) * 1000).toLocaleString();
        document.getElementById('next-lottery').textContent = `Estimated Next Lottery Check: ${nextTime}`;
      }
    }

    function updateContestantsSection(hasOpenGame) {
      document.getElementById('contestants-section').style.display = hasOpenGame ? 'block' : 'none';
    }

    function updateTable(tableId, data, fields, formatTime = false) {
      const tbody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
      tbody.innerHTML = '';
      const entries = Object.values(data);
      if (entries.length === 0) {
        const row = tbody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = fields.length;
        cell.textContent = 'No data';
        return;
      }
      entries.forEach(item => {
        const row = tbody.insertRow();
        fields.forEach(field => {
          const cell = row.insertCell();
          if (field === 'timestamp' && formatTime) {
            cell.textContent = new Date(item[field]).toLocaleString();
          } else if (field === 'txid' && item[field]) {
            const a = document.createElement('a');
            a.href = `https://mempool.space/tx/${item[field]}`;
            a.textContent = item[field].slice(0, 8) + '...';
            a.target = '_blank';
            cell.appendChild(a);
          } else if (field === 'address' || field === 'sender' || field === 'winner') {
            cell.textContent = item[field].slice(0, 8) + '...';
            cell.title = item[field];
          } else {
            cell.textContent = item[field] || '';
          }
        });
      });
    }

    async function resetState() {
      log('Resetting state...');
      const apiKey = prompt('Enter admin API key:');
      if (!apiKey) {
        log('Admin API key required');
        return;
      }
      const data = await fetchWithLogs('/reset?api_key=' + encodeURIComponent(apiKey));
      if (data.success) {
        log('State reset successfully');
      }
      await refresh();
    }

    // Initialize on load
    window.onload = initApp;
  </script>
</body>
</html>