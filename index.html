<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wishy Washy Rune Lottery</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f9f9f9; }
    h1 { color: #333; text-align: center; }
    p { font-size: 16px; margin: 10px 0; }
    #address, #pot, #last-winner, #next-check { font-weight: bold; color: #007bff; }
    #contributors, #pending-contributors { background: white; padding: 15px; border-radius: 8px; margin: 10px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    h3 { color: #555; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
    ul { list-style-type: none; padding: 0; }
    li { background: #f8f9fa; margin: 5px 0; padding: 8px; border-radius: 4px; border-left: 4px solid #007bff; }
    button { background: #007bff; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #logs { white-space: pre-wrap; background: #333; color: #0f0; padding: 10px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    #auto-refresh { margin-right: 10px; }
  </style>
</head>
<body>
  <h1>ðŸŽ° Wishy Washy Rune Lottery</h1>
  <p>Send WISHYWASHYMACHINE Runes to: <span id="address">Loading...</span></p>
  <p>Current Pot: <span id="pot">0 WISHY</span></p>
  <p>Last Winner: <span id="last-winner">None</span></p>
  <p>Estimated Next Lottery Check: <span id="next-check">Calculating...</span></p>
  <div id="contributors">
    <h3>Confirmed Entries:</h3>
    <ul id="contributors-list"></ul>
  </div>
  <div id="pending-contributors">
    <h3>Pending Entries (Unconfirmed):</h3>
    <ul id="pending-list"></ul>
  </div>
  <div style="text-align: center;">
    <button onclick="init()">Init Rune Info</button>
    <button onclick="poll()">Poll for Deposits</button>
    <button onclick="check()">Check Block / Lottery</button>
    <button onclick="updateStatus()">Refresh Status</button>
    <button onclick="reset()">Reset State (Admin)</button>
  </div>
  <p style="text-align: center;"><input type="checkbox" id="auto-refresh" checked> Auto-refresh status every 10 seconds</p>
  <div id="logs">Logs will appear here...</div>
  <script>
    const API_BASE = 'https://wishyroulette.onrender.com'; // Full backend URL for cross-origin calls

    async function log(message) {
      const logs = document.getElementById('logs');
      logs.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
      logs.scrollTop = logs.scrollHeight;
    }

    async function apiFetch(endpoint, options = {}) {
      const url = `${API_BASE}${endpoint}`;
      log(`Fetching ${url}`);
      const res = await fetch(url, options);
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }
      return await res.json();
    }

    async function updateStatus() {
      try {
        const data = await apiFetch('/status');
        document.getElementById('address').textContent = data.address;
        document.getElementById('pot').innerHTML = `${data.pot} WISHY${data.pendingPot > 0 ? ` <small>(+${data.pendingPot} pending)</small>` : ''}`;
        document.getElementById('last-winner').textContent = data.lastWinner || 'None';
        const contribList = document.getElementById('contributors-list');
        contribList.innerHTML = '';
        for (const [addr, amt] of Object.entries(data.contributors || {})) {
          const li = document.createElement('li');
          li.innerHTML = `Player <strong>${btoa(addr + amt).slice(0,6).toUpperCase()}</strong>: ${amt} WISHY<br><small>(${addr.slice(0,8)}...)</small>`;
          contribList.appendChild(li);
        }
        const pendingList = document.getElementById('pending-list');
        pendingList.innerHTML = '';
        for (const [txid, contrib] of Object.entries(data.pendingContributors || {})) {
          const li = document.createElement('li');
          li.innerHTML = `Player <strong>${contrib.alias}</strong>: ${contrib.amount} WISHY (pending)<br><small>(${contrib.sender.slice(0,8)}..., tx: ${txid.slice(0,8)}...)</small>`;
          pendingList.appendChild(li);
        }
        const timeData = await apiFetch('/last-block-time');
        if (timeData.success) {
          const nextCheck = new Date(timeData.timestamp * 1000 + 10 * 60 * 1000).toLocaleString();
          document.getElementById('next-check').textContent = nextCheck;
        }
        log('Status updated successfully');
      } catch (e) {
        log(`Status update error: ${e.message}`);
      }
    }

    async function init() { 
      try {
        const data = await apiFetch('/init'); 
        log('Init: ' + JSON.stringify(data)); 
      } catch (e) {
        log(`Init error: ${e.message}`);
      }
    }

    async function poll() { 
      try {
        const data = await apiFetch('/poll'); 
        log('Poll: ' + JSON.stringify(data)); 
        await updateStatus(); // Refresh UI after poll
      } catch (e) {
        log(`Poll error: ${e.message}`);
      }
    }

    async function check() { 
      try {
        const apiKey = prompt('Enter API Key:');
        if (!apiKey) return;
        const data = await apiFetch(`/check?api_key=${encodeURIComponent(apiKey)}`); 
        log('Check: ' + JSON.stringify(data)); 
      } catch (e) {
        log(`Check error: ${e.message}`);
      }
    }

    async function reset() { 
      try {
        const apiKey = prompt('Enter API Key:');
        if (!apiKey) return;
        const data = await apiFetch(`/reset?api_key=${encodeURIComponent(apiKey)}`); 
        log('Reset: ' + JSON.stringify(data)); 
      } catch (e) {
        log(`Reset error: ${e.message}`);
      }
    }

    // Auto-refresh
    setInterval(() => { 
      if (document.getElementById('auto-refresh').checked) updateStatus(); 
    }, 10000);
    updateStatus(); // Initial load
  </script>
</body>
</html>