<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸŽ° Wishy Washy Rune Lottery</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    h1 { text-align: center; }
    .section { margin: 20px 0; padding: 15px; border: 2px solid #333; border-radius: 10px; background: #f9f9f9; }
    .address { font-family: monospace; word-break: break-all; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #e0e0e0; }
    .buttons { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
    button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; }
    button:hover { background: #0056b3; }
    #logs { white-space: pre-wrap; font-family: monospace; background: #f8f8f8; padding: 10px; height: 200px; overflow-y: auto; border: 1px solid #ddd; }
    .error { color: red; font-weight: bold; }
    .loading { color: #666; }
  </style>
</head>
<body>
  <h1>ðŸŽ° Wishy Washy Rune Lottery</h1>

  <div class="section">
    <h2>1. Send Runes</h2>
    <p>Send WISHYWASHYMACHINE Runes to:</p>
    <p id="address" class="address loading">Loading...</p>
    <p id="pot">Current Pot: 0 WISHY</p>
    <p id="last-winner">Last Winner: None</p>
    <p id="next-lottery" class="loading">Estimated Next Lottery Check: Calculating...</p>
    <p id="balance-error" class="error" style="display: none;"></p>
  </div>

  <div class="section" id="contestants-section" style="display: none;">
    <h2>2. Confirmed Contestants (Current Game)</h2>
    <table id="contestants">
      <thead>
        <tr>
          <th>Alias</th>
          <th>Address</th>
          <th>Amount (WISHY)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>3. Pending Entries (Next Game)</h2>
    <table id="pending">
      <thead>
        <tr>
          <th>Alias</th>
          <th>Address</th>
          <th>Amount (WISHY)</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>4. Past Games</h2>
    <table id="history">
      <thead>
        <tr>
          <th>Winner</th>
          <th>Amount (WISHY)</th>
          <th>Date</th>
          <th>TxID</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="buttons">
    <button onclick="init()">Init Rune Info</button>
    <button onclick="poll()">Poll for Deposits</button>
    <button onclick="check()">Check Block / Lottery</button>
    <button onclick="refresh()">Refresh Status</button>
    <button onclick="promptReset()">Reset State (Admin)</button>
  </div>

  <div class="section">
    <h2>Logs</h2>
    <div id="logs">Logs will appear here...</div>
  </div>

  <script>
    const apiUrl = 'https://wishyroulette.onrender.com';
    const networkType = 'mainnet'; // Updated to mainnet as per logs
    let lastLogTime = 0;

    async function fetchWithLogs(url) {
      const now = Date.now();
      if (now - lastLogTime > 1000) {
        log(`Fetching ${url.replace(apiUrl, '')}`);
        lastLogTime = now;
      }
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`${response.status} ${response.statusText}`);
        }
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.error || 'Unknown error');
        }
        return data;
      } catch (e) {
        log(`Error fetching ${url.replace(apiUrl, '')}: ${e.message}`);
        return { success: false, error: e.message };
      }
    }

    function log(message) {
      const logs = document.getElementById('logs');
      logs.innerHTML += `${new Date().toLocaleTimeString()}: ${message}\n`;
      logs.scrollTop = logs.scrollHeight;
    }

    async function init() {
      log('Initializing...');
      const data = await fetchWithLogs(`${apiUrl}/init`);
      if (data.success) {
        log(`Rune ID: ${data.runeId}, Decimals: ${data.decimals}`);
      } else {
        log(`Init failed: ${data.error}`);
      }
      await refresh();
    }

    async function poll() {
      log('Polling for deposits...');
      const data = await fetchWithLogs(`${apiUrl}/poll`);
      if (data.success) {
        log(`Poll completed: ${data.newContributions || 0} new contributions, ${data.newWithdrawals || 0} withdrawals`);
      } else {
        log(`Poll failed: ${data.error}`);
      }
      await refresh();
    }

    async function check() {
      log('Checking block / lottery...');
      const apiKey = prompt('Enter admin API key:');
      if (!apiKey) {
        log('Admin API key required');
        return;
      }
      const data = await fetchWithLogs(`${apiUrl}/check?api_key=${encodeURIComponent(apiKey)}`);
      if (data.success && data.winner) {
        log(`ðŸŽ‰ Winner: ${data.winner.slice(0, 8)}...`);
      } else if (data.success) {
        log(data.message || 'No action taken');
      } else {
        log(`Check failed: ${data.error}`);
      }
      await refresh();
    }

    async function refresh() {
      log('Refreshing status...');
      const status = await fetchWithLogs(`${apiUrl}/status`);
      if (status) {  // Allow partial data even if not success
        document.getElementById('address').textContent = status.address || 'Unknown';
        document.getElementById('pot').textContent = `Current Pot: ${status.pot || 0} WISHY`;
        document.getElementById('last-winner').textContent = `Last Winner: ${status.lastWinner || 'None'}`;
        document.getElementById('balance-error').style.display = status.balanceError ? 'block' : 'none';
        document.getElementById('balance-error').textContent = status.balanceError || '';
        updateTable('contestants', status.contributors || {}, ['address', 'amount']);
        updateTable('pending', status.pendingContributors || {}, ['alias', 'sender', 'amount', 'status']);
        updateContestantsSection(status.hasOpenGame);
      } else {
        log(`Status fetch failed`);
      }

      const history = await fetchWithLogs(`${apiUrl}/history`);
      if (history && history.success) {
        updateTable('history', history.games || [], ['winner', 'amount', 'timestamp', 'txid'], true);
      } else {
        log(`History fetch failed: ${history ? history.error : 'Unknown'}`);
      }

      const blockTime = await fetchWithLogs(`${apiUrl}/last-block-time`);
      if (blockTime && blockTime.success) {
        const nextTime = new Date((blockTime.timestamp + 600) * 1000).toLocaleString();
        document.getElementById('next-lottery').textContent = `Estimated Next Lottery Check: ${nextTime}`;
      } else {
        document.getElementById('next-lottery').textContent = 'Estimated Next Lottery Check: API Error';
        log(`Block time fetch failed: ${blockTime ? blockTime.error : 'Unknown'}`);
      }
    }

    function updateContestantsSection(hasOpenGame) {
      const section = document.getElementById('contestants-section');
      section.style.display = hasOpenGame ? 'block' : 'none';
    }

    function updateTable(tableId, data, fields, formatTime = false) {
      const tbody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
      tbody.innerHTML = '';
      const entries = Object.values(data);
      if (entries.length === 0) {
        const row = tbody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = fields.length;
        cell.textContent = 'No data';
        cell.className = 'loading';
        return;
      }
      entries.forEach(item => {
        const row = tbody.insertRow();
        fields.forEach(field => {
          const cell = row.insertCell();
          let value = item[field];
          if (field === 'timestamp' && formatTime && value) {
            cell.textContent = new Date(value).toLocaleString();
          } else if (field === 'txid' && value) {
            const a = document.createElement('a');
            a.href = `https://mempool.space/${networkType === 'testnet' ? 'testnet/' : ''}tx/${value}`;
            a.textContent = value.slice(0, 8) + '...';
            a.target = '_blank';
            cell.appendChild(a);
          } else if (field === 'address' || field === 'sender' || field === 'winner') {
            cell.textContent = value ? value.slice(0, 8) + '...' : '';
            if (value) cell.title = value;
          } else {
            cell.textContent = value || '';
          }
        });
      });
    }

    async function promptReset() {
      const apiKey = prompt('Enter admin API key:');
      if (!apiKey) {
        log('Admin API key required');
        return;
      }
      log('Resetting state...');
      const data = await fetchWithLogs(`${apiUrl}/reset?api_key=${encodeURIComponent(apiKey)}`);
      if (data.success) {
        log('State reset successfully');
      } else {
        log(`Reset failed: ${data.error}`);
      }
      await refresh();
    }

    // Auto-refresh every 30 seconds
    setInterval(refresh, 30000);

    // Initial load
    window.onload = () => {
      log('App loaded');
      setTimeout(init, 1000);  // Delay initial init to allow server warmup
    };
  </script>
</body>
</html>